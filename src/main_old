#include <Arduino.h>
#include <WiFi.h>
#include <AsyncTCP.h>
#include <ESPAsyncWebServer.h>
#include <ESPAsyncDNSServer.h>
#include <ESPAsync_WiFiManager.h>
#include <ElegantOTA.h>
#include <Preferences.h>

// Objets globaux
AsyncWebServer server(80);
AsyncDNSServer dns;
ESPAsync_WiFiManager wifiManager(&server, &dns);
Preferences preferences;

// Configuration réseau
IPAddress local_IP(192, 168, 1, 104);
IPAddress gateway(192, 168, 1, 1);
IPAddress subnet(255, 255, 0, 0);

// Pins relais et LED
uint8_t pinK1 = 21;
uint8_t pinK2 = 19;
uint8_t pinK3 = 18;
uint8_t pinK4 = 5;
uint8_t pinredLed = 25;
int relayPins[] = {21, 19, 18, 5};

// Fonctions utilitaires
void blinkRedLed() {
  digitalWrite(pinredLed, LOW);
  delay(100);
  digitalWrite(pinredLed, HIGH);
  delay(100);
}

void startrelais(const int* pins, int pin_nb){
  digitalWrite(pins[pin_nb-1], HIGH);
  Serial.print("Started relais K");
  Serial.println(pin_nb);
}

void stoprelais(const int* pins, int pin_nb){
  digitalWrite(pins[pin_nb-1], LOW);
  Serial.print("Stoped relais K");
  Serial.println(pin_nb);
}

void handleStart(AsyncWebServerRequest *request) {
  if (request->hasParam("relay")) {
    String paramValue = request->getParam("relay")->value();
    if (paramValue=="all"){
      for (int i=1; i<5;i++){
        startrelais(relayPins, i);
        blinkRedLed();
      }
      request->send(200, "text/plain", "All relays started");
    }
    else{
      int relayIndex = paramValue.toInt();
      startrelais(relayPins, relayIndex);
      blinkRedLed();
      request->send(200, "text/plain", "Relay started: " + String(relayIndex));
    }
  } else {
    request->send(400, "text/plain", "Missing relay parameter");
  }
}

void handleStop(AsyncWebServerRequest *request) {
  if (request->hasParam("relay")) {
    String paramValue = request->getParam("relay")->value();
    if (paramValue=="all"){
      for (int i=1; i<5;i++){
        stoprelais(relayPins, i);
        blinkRedLed();
      }
      request->send(200, "text/plain", "All relays stoped");
    }
    else{
      int relayIndex = paramValue.toInt();
      stoprelais(relayPins, relayIndex);
      blinkRedLed();
      request->send(200, "text/plain", "Relay stoped: " + String(relayIndex));
    }
  } else {
    request->send(400, "text/plain", "Missing relay parameter");
  }
}

void setup() {
  Serial.begin(115200);
  Serial.println("Booting ESP32 Relay...");
  pinMode(pinredLed, OUTPUT);
  digitalWrite(pinredLed, HIGH);
  blinkRedLed();

  WiFi.mode(WIFI_STA);
  // WiFi.config(local_IP, gateway, subnet); // <-- à réactiver si le réseau accepte l'IP statique
  wifiManager.autoConnect("ESP32-Relay-Setup");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
  blinkRedLed();

  preferences.begin("relay", false);
  for (int i = 0; i < 4; i++) {
    int pin = preferences.getInt((String("pin") + String(i+1)).c_str(), relayPins[i]);
    relayPins[i] = pin;
  }

  for (int i = 0; i < 4; i++) {
    pinMode(relayPins[i], OUTPUT);
    blinkRedLed();
    digitalWrite(relayPins[i], LOW);
  }

  server.on("/start", HTTP_GET, handleStart);
  server.on("/stop", HTTP_GET, handleStop);

  server.on("/config", HTTP_GET, [](AsyncWebServerRequest *request){
    String html = "<html><head><title>Config Relais</title></head><body>";
    html += "<h2>Configuration des pins relais</h2>";
    html += "<form method='POST' action='/config'>";
    for (int i=0; i<4; i++) {
      html += "Pin Relais " + String(i+1) + ": <input type='number' name='pin" + String(i+1) + "' value='" + String(relayPins[i]) + "'><br>";
    }
    html += "<input type='submit' value='Enregistrer'>";
    html += "</form></body></html>";
    request->send(200, "text/html", html);
  });

  server.on("/config", HTTP_POST, [](AsyncWebServerRequest *request){
    for (int i=0; i<4; i++) {
      if (request->hasParam("pin" + String(i+1), true)) {
        int newPin = request->getParam("pin" + String(i+1), true)->value().toInt();
        relayPins[i] = newPin;
        preferences.putInt((String("pin") + String(i+1)).c_str(), newPin);
      }
    }
    request->send(200, "text/html", "<html><body><h2>Configuration enregistrée !</h2><a href='/config'>Retour</a></body></html>");
  });

  ElegantOTA.begin(&server);
  server.begin();
}

void loop() {
  // Main code after setup
}
